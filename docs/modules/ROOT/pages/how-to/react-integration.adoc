= PSD3 in a React Application
:description: How to integrate PSD3 visualizations into purescript-react-basic-hooks applications
:keywords: React, react-basic-hooks, integration, framework-agnostic

PSD3 is framework-agnostic: the same visualization code works whether you're using React, Halogen, or vanilla JavaScript. This guide shows how to integrate PSD3 with `purescript-react-basic-hooks`.

== The Key Insight

PSD3 doesn't care about your UI framework. It just needs:

1. A DOM element to render into
2. A trigger to render (mount, prop change, etc.)

The framework provides the container and lifecycle; PSD3 handles the visualization.

== The Pattern

[source,purescript]
----
mkMyVisualization :: Component { data :: Array Number }
mkMyVisualization = do
  -- 1. Generate unique container ID (once per component instance)
  containerId <- useContainerId

  component "MyVisualization" \props -> React.do
    -- 2. Render visualization when component mounts
    useEffectOnce do
      void $ runD3 do
        let selector = "#" <> containerId
        clear selector
        container <- select selector
        renderTree container (myVisualizationAST props.data)
      pure mempty

    -- 3. Return container div with our unique ID
    pure $ R.div
      { id: containerId
      , style: R.css { width: "500px", height: "300px" }
      }
----

== Container ID Helper

Each component instance needs a unique container ID to avoid conflicts when multiple visualizations are on the same page.

.src/PSD3/React/Hooks.purs
[source,purescript]
----
module PSD3.React.Hooks (useContainerId) where

import Effect (Effect)

foreign import generateContainerIdImpl :: Effect String

useContainerId :: Effect String
useContainerId = generateContainerIdImpl
----

.src/PSD3/React/Hooks.js
[source,javascript]
----
let counter = 0;

export const generateContainerIdImpl = () => `psd3-container-${counter++}`;
----

== Complete Bar Chart Example

Here's a complete example showing a data-bound bar chart:

[source,purescript]
----
module PSD3.React.Example where

import Prelude

import Data.Int (toNumber)
import Effect (Effect)
import PSD3.AST as A
import PSD3.AST (ElementType(..))
import PSD3.Expr.Friendly (num, text, computed, computedStr, fromWithIndex, fromStrWithIndex)
import PSD3.React.Hooks (useContainerId)
import PSD3.Render (runD3, select, renderTree, clear)
import React.Basic.DOM as R
import React.Basic.Hooks (Component, component, useEffectOnce)
import React.Basic.Hooks as React

-- | Bar chart component with data binding
mkBarChart :: Component { chartData :: Array Number }
mkBarChart = do
  containerId <- useContainerId

  component "BarChart" \props -> React.do
    useEffectOnce do
      void $ runD3 do
        let selector = "#" <> containerId
        clear selector
        container <- select selector
        renderTree container (barChartAST props.chartData)
      pure mempty

    pure $ R.div
      { id: containerId
      , style: R.css { width: "500px", height: "300px" }
      }

-- | The visualization AST - identical to what you'd write for Halogen
barChartAST :: Array Number -> A.AST Number
barChartAST dataset =
  A.elem SVG
    [ computed "width" (num 500.0)
    , computed "height" (num 300.0)
    , computedStr "style" (text "background: #f5f5f5")
    ]
    `A.withChild`
      A.joinData "bars" "rect" dataset \_ ->
        A.elem Rect
          -- x position depends on index (bar number)
          [ fromWithIndex "x" (\_ i -> toNumber i * 60.0 + 20.0)
          -- y position depends on value (grows upward)
          , fromWithIndex "y" (\val _ -> 280.0 - val * 2.5)
          -- fixed width
          , computed "width" (num 50.0)
          -- height depends on value
          , fromWithIndex "height" (\val _ -> val * 2.5)
          -- color depends on value threshold
          , fromStrWithIndex "fill" (\val _ ->
              if val > 75.0 then "steelblue"
              else if val > 50.0 then "cornflowerblue"
              else "lightsteelblue")
          ]
----

== Using DOM Elements Directly

If you prefer using React refs instead of CSS selectors, PSD3 provides `selectElement`:

[source,purescript]
----
import PSD3.Render (runD3, selectElement, renderTree)
import React.Basic.Hooks (useRef)
import Web.HTML.HTMLElement (toElement)
import Data.Nullable (toMaybe)

mkChartWithRef :: Component { data :: Array Number }
mkChartWithRef = do
  component "ChartWithRef" \props -> React.do
    containerRef <- useRef null

    useEffectOnce do
      for_ (toMaybe =<< toMaybe containerRef.current) \htmlEl -> do
        let element = toElement htmlEl
        void $ runD3 do
          container <- selectElement element
          renderTree container (myChartAST props.data)
      pure mempty

    pure $ R.div { ref: containerRef }
----

== Responding to Prop Changes

To re-render when props change, use `useEffect` with a dependency:

[source,purescript]
----
mkDynamicChart :: Component { chartData :: Array Number }
mkDynamicChart = do
  containerId <- useContainerId

  component "DynamicChart" \props -> React.do
    -- Re-render when chartData changes
    useEffect props.chartData do
      void $ runD3 do
        let selector = "#" <> containerId
        clear selector
        container <- select selector
        renderTree container (barChartAST props.chartData)
      pure mempty

    pure $ R.div { id: containerId }
----

== Project Setup

Add these dependencies to your `spago.yaml`:

[source,yaml]
----
package:
  dependencies:
    - psd3-selection
    - react-basic
    - react-basic-dom
    - react-basic-hooks
----

If using local PSD3 packages:

[source,yaml]
----
workspace:
  extraPackages:
    psd3-selection:
      path: ../purescript-psd3-selection
    psd3-tree:
      path: ../purescript-psd3-tree
    psd3-graph:
      path: ../purescript-psd3-graph
----

== Why Framework-Agnostic Matters

The visualization code (`barChartAST`) is completely decoupled from React. This means:

* **Reusable**: The same AST works in Halogen, React, or vanilla JS
* **Testable**: Test visualization logic without a framework
* **Portable**: Switch frameworks without rewriting visualizations

== Next Steps

* xref:how-to/react-events.adoc[React Events from PSD3] - Click handlers and state updates
* xref:how-to/react-simulation.adoc[Force Simulations in React] - Tick callbacks and drag
* xref:how-to/halogen-events.adoc[Halogen Events from PSD3] - Compare with Halogen
* xref:how-to/simple-webpage.adoc[PSD3 in a Simple Web Page] - No framework at all
